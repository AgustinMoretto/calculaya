<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>CalculaYa Pro - Agustin Moretto</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffcc00">
    <link rel="apple-touch-icon" href="icono-512.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { --primary: #ffcc00; --bg: #0d0d0d; --card: #1a1a1a; --text: #ffffff; --text-dim: #888; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro", sans-serif; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        header { padding: calc(env(safe-area-inset-top) + 15px) 20px 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(13, 13, 13, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid #222; position: sticky; top: 0; z-index: 1100; }
        .menu-icon { width: 24px; height: 18px; cursor: pointer; display: flex; flex-direction: column; justify-content: space-between; }
        .menu-icon span { display: block; width: 100%; height: 2px; background: var(--primary); border-radius: 4px; }
        .sidebar { position: fixed; top: 0; left: -100%; width: 85%; max-width: 320px; height: 100%; background: #111; z-index: 2000; transition: 0.4s; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .sidebar.active { left: 0; }
        .btn-cerrar-menu { background: #222; color: var(--primary); border: 1px solid #333; padding: 12px; border-radius: 12px; width: 100%; margin-bottom: 30px; font-weight: bold; }
        #app-container { padding: 15px; max-width: 800px; margin: 0 auto; }
        .cat-title { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 2px; margin: 30px 0 10px 5px; border-left: 2px solid var(--primary); padding-left: 8px; }
        .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .btn-gremio { background: var(--card); border: 1px solid #222; border-radius: 16px; padding: 15px 10px; color: var(--text); font-size: 0.85rem; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .btn-gremio span { font-size: 1.4rem; }
        .hidden { display: none !important; }
        section { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 15px; border: 1px solid #222; }
        h4 { margin: 0 0 15px 0; font-size: 0.7rem; color: var(--primary); text-transform: uppercase; }
        input, select { width: 100%; padding: 16px; margin: 8px 0; border: 1px solid #333; border-radius: 14px; background: #000; color: white; font-size: 16px; box-sizing: border-box; }
        .btn-accion { background: var(--primary); color: #000; font-weight: 800; width: 100%; padding: 18px; border-radius: 16px; border:none; font-size: 1rem; margin-top: 10px; }
        .fav-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .fav-chip { background: #222; padding: 8px 15px; border-radius: 50px; font-size: 0.8rem; border: 1px solid #333; white-space: nowrap; }
        .recargo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px; }
        .btn-recargo { background: #000; color: var(--primary); border: 1px solid var(--primary); padding: 10px; border-radius: 10px; font-size: 0.8rem; }
        #ticket-wrapper { display: flex; justify-content: center; width: 100%; margin-top: 20px; }
        #ticket-resultado { background: #fff; color: #000; padding: 20px; border-radius: 2px; font-family: 'Courier New', monospace; width: 100%; max-width: 320px; }
        #signature-pad { border: 1px dashed #444; background: #fff; border-radius: 12px; touch-action: none; width: 100%; height: 150px; }
        .clear-sig { color: var(--primary); font-size: 0.7rem; text-decoration: underline; background: none; border: none; padding: 10px 0; }
        #buscador { background: #1a1a1a; border: 1px solid var(--primary); color: #fff; margin-bottom: 20px; border-radius: 50px; padding: 15px 25px; box-sizing: border-box; width: 100%; }
        .btn-geo { background: #333; color: #fff; font-size: 0.7rem; padding: 8px; border-radius: 8px; border: none; width: 100%; margin-top: 5px; }
    </style>
</head>
<body>

    <header>
        <div class="menu-icon" onclick="toggleMenu()"><span></span><span></span><span></span></div>
        <div style="font-weight: 900; font-size: 1.2rem;">CALCULAYA <span style="color:var(--primary)">PRO</span></div>
        <div style="width: 24px;"></div>
    </header>

    <div class="sidebar" id="sidebar">
        <button class="btn-cerrar-menu" onclick="toggleMenu()">‚úï CERRAR MEN√ö</button>
        <div style="color:var(--text-dim); font-size:0.7rem; margin-bottom:5px;">LOGO DE TU EMPRESA</div>
        <input type="file" id="p-logo-input" accept="image/*" onchange="loadLogo(event)">
        
        <div style="color:var(--text-dim); font-size:0.7rem; margin-top: 15px;">MONEDA</div>
        <select id="p-moneda" onchange="saveCfg()">
            <option value="$">Peso ($)</option>
            <option value="USD">D√≥lar (USD)</option>
            <option value="‚Ç¨">Euro (‚Ç¨)</option>
            <option value="CLP">CLP</option>
            <option value="MXN">MXN</option>
        </select>

        <div style="color:var(--text-dim); font-size:0.7rem; margin-top: 15px;">TUS DATOS</div>
        <input type="text" id="p-nom" placeholder="Tu Nombre / Empresa" onchange="saveCfg()">
        <input type="text" id="p-ext" placeholder="WhatsApp / Tel√©fono" onchange="saveCfg()">
        
        <div style="color:var(--text-dim); font-size:0.7rem; margin:20px 0 5px;">HISTORIAL</div>
        <div id="lista-historial"></div>
    </div>

    <div id="app-container">
        <div id="pantalla-inicio">
            <button class="btn-accion" style="background:#fff; margin-bottom:10px;" onclick="goCalc('R√°pido', '‚ö°')">‚ö° PRESUPUESTO R√ÅPIDO</button>
            <input type="text" id="buscador" placeholder="üîç Buscar oficio..." onkeyup="filtrarOficios()">
            <div id="grid-oficios"></div>
        </div>

        <div id="pantalla-calculadora" class="hidden">
            <button onclick="goHome()" style="background:none; border:none; color:var(--text-dim); margin-bottom:15px;">‚Üê VOLVER</button>
            
            <section>
                <h4>Datos del Cliente</h4>
                <input type="text" id="in-cliente" list="clientes-list" placeholder="Nombre del Cliente">
                <datalist id="clientes-list"></datalist>
                <input type="text" id="in-geo" placeholder="Direcci√≥n del trabajo">
                <button class="btn-geo" onclick="obtenerGeo()">üìç Obtener ubicaci√≥n actual</button>
                <select id="doc-tipo"><option>PRESUPUESTO</option><option>ORDEN DE TRABAJO</option><option>RECIBO</option></select>
                <h2 id="view-title"></h2>
            </section>

            <section>
                <h4>Items y Tareas</h4>
                <div class="fav-scroll" id="lista-favs"></div>
                <input type="text" id="in-nom" placeholder="Descripci√≥n">
                <input type="number" id="in-pre" placeholder="Precio">
                <button class="btn-accion" onclick="addItem()" style="background:#000; color:var(--primary); border: 1px solid var(--primary);">+ AGREGAR</button>
                <div id="lista-items" style="margin-top:15px; font-size:0.9rem;"></div>
            </section>

            <section>
                <h4>Firma de Conformidad</h4>
                <canvas id="signature-pad"></canvas>
                <button class="clear-sig" onclick="clearSig()">Borrar Firma</button>
            </section>

            <section>
                <h4>Mano de Obra / Total</h4>
                <input type="number" id="mo-pre" placeholder="Monto Mano de Obra">
                <div class="recargo-grid">
                    <button class="btn-recargo" onclick="aplicarRecargo(1.1)">+10%</button>
                    <button class="btn-recargo" onclick="aplicarRecargo(1.21)">+21%</button>
                    <button class="btn-recargo" onclick="aplicarRecargo(1.5)">+50%</button>
                </div>
            </section>

            <button class="btn-accion" onclick="calc()">GENERAR COMPROBANTE</button>

            <div id="res-box" class="hidden">
                <div id="ticket-wrapper">
                    <div id="ticket-resultado">
                        <div style="text-align:center; border-bottom:1px solid #ccc; padding-bottom:10px; margin-bottom:10px;">
                            <img id="tk-logo-img" style="max-height: 45px; display: none; margin: 0 auto 10px;">
                            <h3 id="tk-doc-tipo" style="margin:0; font-size: 1rem;"></h3>
                            <b id="tk-emp" style="font-size:0.8rem;"></b><br>
                            <small id="tk-ext" style="font-size:0.6rem;"></small><br>
                            <div id="tk-cliente-v" style="margin-top:5px; font-size:0.6rem; font-weight: bold; border: 1px solid #000; padding: 2px 8px;"></div>
                            <div id="tk-geo-v" style="font-size:0.5rem; color:#666; margin-top:3px;"></div>
                        </div>
                        <div id="tk-list" style="font-size: 0.75rem;"></div>
                        <div style="text-align:right; border-top:2px solid #000; margin-top:10px; padding-top:10px;"><b id="tk-tot" style="font-size:1rem;"></b></div>
                        <div style="margin-top:15px; text-align:center;">
                            <div style="font-size:0.4rem; color:#555; text-transform:uppercase;">Firma de Conformidad:</div>
                            <img id="tk-firma" style="max-height:55px; margin-top:5px;">
                        </div>
                    </div>
                </div>
                <button class="btn-accion" onclick="shareWA()" style="background:#25d366; color:#fff;">ENVIAR POR WHATSAPP üì±</button>
                <button class="btn-accion" onclick="descargarTicket('png')" style="background:#444; color:#fff;">DESCARGAR IMAGEN üì•</button>
                <button class="btn-accion" onclick="descargarTicket('pdf')" style="background:#d32f2f; color:#fff;">DESCARGAR PDF üìÑ</button>
                <button class="btn-accion" onclick="goHome()" style="background:#222; color:#fff;">NUEVO TRABAJO</button>
            </div>
        </div>
    </div>

    <script>
        const oficios = {
            "Construcci√≥n": [{n: "Alba√±il", i: "üß±"}, {n: "Pintor", i: "üé®"}, {n: "Plomero", i: "üö∞"}, {n: "Electricista", i: "‚ö°"}, {n: "Carpintero", i: "üî®"}, {n: "Herrero", i: "‚öíÔ∏è"}, {n: "Techista", i: "üè†"}, {n: "Gasista", i: "üî•"}, {n: "Durlockero", i: "ü™ú"}, {n: "Yesero", i: "‚òÅÔ∏è"}, {n: "Zinguero", i: "üèóÔ∏è"}, {n: "Vidriero", i: "ü™ü"}, {n: "Cerrajero", i: "üîë"}, {n: "Piso Flotante", i: "ü™µ"}, {n: "Maestro Mayor", i: "üìê"}],
            "Mec√°nica & Motor": [{n: "Mec√°nico", i: "üîß"}, {n: "Gomero", i: "üõû"}, {n: "Chapa y Pintura", i: "üöó"}, {n: "Electricidad Auto", i: "üîã"}, {n: "Audio Car", i: "üîä"}, {n: "Detailing", i: "‚ú®"}, {n: "Lavadero", i: "üßº"}, {n: "Mec√°nico Moto", i: "üèçÔ∏è"}],
            "Hogar & Mantenimiento": [{n: "Aire Acond.", i: "‚ùÑÔ∏è"}, {n: "Jardinero", i: "üåø"}, {n: "Fumigador", i: "üêú"}, {n: "Piscinas", i: "üèä"}, {n: "Limpieza", i: "üßπ"}, {n: "Flete/Mudanza", i: "üì¶"}, {n: "Tapicero", i: "üõãÔ∏è"}, {n: "Alarmas/CCTV", i: "üõ°Ô∏è"}],
            "Digital & Est√©tica": [{n: "Peluquero", i: "‚úÇÔ∏è"}, {n: "Barbero", i: "üíà"}, {n: "Manicura", i: "üíÖ"}, {n: "Tatuador", i: "üñãÔ∏è"}, {n: "Programador", i: "üíª"}, {n: "Dise√±ador", i: "üé®"}, {n: "T√©cnico Cel", i: "üì±"}, {n: "Fot√≥grafo", i: "üì∏"}],
            "Servicios & Otros": [{n: "Catering", i: "üçΩÔ∏è"}, {n: "Pasteler√≠a", i: "üéÇ"}, {n: "DJ/Sonido", i: "üéß"}, {n: "Costurera", i: "ü™°"}, {n: "Zapatero", i: "üëû"}, {n: "Luthier", i: "üé∏"}, {n: "Artesano", i: "üè∫"}, {n: "Cadete", i: "üõµ"}]
        };

        let cart = [], currentR = "", total = 0, logoData = localStorage.getItem('app_logo') || "";
        let favs = JSON.parse(localStorage.getItem('favs_v2')) || [];
        let clientesSet = new Set(JSON.parse(localStorage.getItem('app_clientes')) || []);
        const canvas = document.getElementById('signature-pad');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function loadLogo(e) { const reader = new FileReader(); reader.onload = () => { logoData = reader.result; localStorage.setItem('app_logo', logoData); alert("Logo guardado"); }; reader.readAsDataURL(e.target.files[0]); }
        function obtenerGeo() { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { document.getElementById('in-geo').value = `Lat: ${pos.coords.latitude.toFixed(4)}, Lon: ${pos.coords.longitude.toFixed(4)}`; }); } }
        function filtrarOficios() { let bus = document.getElementById('buscador').value.toLowerCase(); document.querySelectorAll('.btn-gremio').forEach(btn => btn.style.display = btn.innerText.toLowerCase().includes(bus) ? 'flex' : 'none'); }
        function resizeCanvas() { canvas.width = canvas.parentElement.clientWidth - 40; canvas.height = 150; ctx.strokeStyle = "#000"; ctx.lineWidth = 2; }
        function draw(e) { if (!drawing) return; const rect = canvas.getBoundingClientRect(); const x = (e.clientX || (e.touches ? e.touches[0].clientX : 0)) - rect.left; const y = (e.clientY || (e.touches ? e.touches[0].clientY : 0)) - rect.top; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y); }
        canvas.addEventListener('mousedown', () => drawing = true);
        canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchstart', (e) => { drawing = true; e.preventDefault(); });
        canvas.addEventListener('touchend', () => { drawing = false; ctx.beginPath(); });
        canvas.addEventListener('touchmove', (e) => { draw(e); e.preventDefault(); });
        function clearSig() { ctx.clearRect(0, 0, canvas.width, canvas.height); }
        function toggleMenu() { document.getElementById('sidebar').classList.toggle('active'); renderHist(); }
        function goCalc(r, icon) { currentR = r; document.getElementById('pantalla-inicio').classList.add('hidden'); document.getElementById('pantalla-calculadora').classList.remove('hidden'); document.getElementById('view-title').innerText = icon + " " + r; renderFavs(); setTimeout(resizeCanvas, 100); }
        function goHome() { document.getElementById('pantalla-inicio').classList.remove('hidden'); document.getElementById('pantalla-calculadora').classList.add('hidden'); cart = []; document.getElementById('lista-items').innerHTML = ""; document.getElementById('mo-pre').value = ""; document.getElementById('in-cliente').value=""; document.getElementById('in-geo').value=""; clearSig(); document.getElementById('res-box').classList.add('hidden'); }
        function addItem() { const n = document.getElementById('in-nom').value, p = document.getElementById('in-pre').value; if(!n || !p) return; cart.push({n, p: parseFloat(p)}); document.getElementById('lista-items').innerHTML = cart.map(it => `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #222;">${it.n} <b>$${it.p}</b></div>`).join(''); document.getElementById('in-nom').value = ""; document.getElementById('in-pre').value = ""; }
        function aplicarRecargo(f) { let val = document.getElementById('mo-pre').value; if(val) document.getElementById('mo-pre').value = Math.round(val * f); }
        function renderFavs() { document.getElementById('lista-favs').innerHTML = favs.map(f => `<div class="fav-chip" onclick="cart.push({n:'${f.n}', p:${f.p}}); addItem();">${f.n}</div>`).join(''); }

        function calc() {
            const mo = parseFloat(document.getElementById('mo-pre').value) || 0;
            const cli = document.getElementById('in-cliente').value;
            const geo = document.getElementById('in-geo').value;
            const mon = document.getElementById('p-moneda').value;
            if(cli) { clientesSet.add(cli); localStorage.setItem('app_clientes', JSON.stringify(Array.from(clientesSet))); }
            total = cart.reduce((s, it) => s + it.p, 0) + mo;
            document.getElementById('tk-doc-tipo').innerText = document.getElementById('doc-tipo').value;
            document.getElementById('tk-emp').innerText = (document.getElementById('p-nom').value || "MI EMPRESA").toUpperCase();
            document.getElementById('tk-ext').innerText = document.getElementById('p-ext').value || currentR;
            document.getElementById('tk-cliente-v').innerText = "PARA: " + (cli ? cli.toUpperCase() : "CONSUMIDOR FINAL");
            document.getElementById('tk-geo-v').innerText = geo ? "üìç " + geo : "";
            if(logoData) { document.getElementById('tk-logo-img').src = logoData; document.getElementById('tk-logo-img').style.display = "block"; }
            document.getElementById('tk-list').innerHTML = cart.map(it => `<div style="display:flex; justify-content:space-between; margin-bottom:2px;"><span>${it.n}</span><span>${mon} ${it.p}</span></div>`).join('') + `<div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><span>MANO DE OBRA</span><span>${mon} ${mo}</span></div>`;
            document.getElementById('tk-tot').innerText = "TOTAL: " + mon + " " + total.toLocaleString();
            document.getElementById('tk-firma').src = canvas.toDataURL();
            document.getElementById('res-box').classList.remove('hidden');
            saveHist();
        }

        async function descargarTicket(fmt) { 
            const node = document.getElementById('ticket-resultado');
            const canvasT = await html2canvas(node, { backgroundColor: "#ffffff", scale: 3 }); 
            const dataImg = canvasT.toDataURL("image/png");
            if(fmt === 'png') { const link = document.createElement('a'); link.download = `Comprobante.png`; link.href = dataImg; link.click(); }
            else { const { jsPDF } = window.jspdf; const pdf = new jsPDF(); pdf.addImage(dataImg, 'PNG', 10, 10, 60, 0); pdf.save("Comprobante.pdf"); }
        }

        function shareWA() { let msg = `*${document.getElementById('doc-tipo').value}*\nCLIENTE: ${document.getElementById('in-cliente').value || 'Final'}\n`; cart.forEach(it => msg += `‚Ä¢ ${it.n}: $${it.p}\n`); msg += `\n*TOTAL: ${document.getElementById('p-moneda').value} ${total.toLocaleString()}*`; window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank'); }
        function saveHist() { let h = JSON.parse(localStorage.getItem('h_pro')) || []; h.unshift({id: Date.now(), r: currentR, t: total, f: new Date().toLocaleDateString()}); localStorage.setItem('h_pro', JSON.stringify(h.slice(0,10))); }
        function renderHist() { let h = JSON.parse(localStorage.getItem('h_pro')) || []; document.getElementById('lista-historial').innerHTML = h.map(x => `<div class="hist-item"><b>${x.r}</b>: $${x.t.toLocaleString()} <span class="btn-del-hist" onclick="delHist(${x.id})">‚úï</span></div>`).join(''); }
        function delHist(id) { let h = JSON.parse(localStorage.getItem('h_pro')) || []; localStorage.setItem('h_pro', JSON.stringify(h.filter(x => x.id !== id))); renderHist(); }
        function saveCfg() { localStorage.setItem('cfg_v6', JSON.stringify({n: document.getElementById('p-nom').value, e: document.getElementById('p-ext').value, m: document.getElementById('p-moneda').value})); }

        const grid = document.getElementById('grid-oficios');
        Object.keys(oficios).forEach(cat => {
            grid.innerHTML += `<div class="cat-title">${cat}</div><div class="menu-grid" id="grid-${cat.replace(/ /g,'')}"></div>`;
            const subGrid = document.getElementById(`grid-${cat.replace(/ /g,'')}`);
            oficios[cat].forEach(of => { subGrid.innerHTML += `<button class="btn-gremio" onclick="goCalc('${of.n}', '${of.i}')"><span>${of.i}</span>${of.n}</button>`; });
        });

        window.onload = () => { const d = JSON.parse(localStorage.getItem('cfg_v6')); if(d){ document.getElementById('p-nom').value = d.n; document.getElementById('p-ext').value = d.e; document.getElementById('p-moneda').value = d.m || "$"; } };

        // REGISTRO DEL SERVICE WORKER PARA MODO OFFLINE
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log("SW fall√≥", err));
            });
        }
    </script>
</body>
</html>